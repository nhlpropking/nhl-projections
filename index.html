<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL Projections</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 12px; }
    .wrap { max-width: 1400px; margin: 0 auto; }
    .meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }
    table.dataTable thead th { white-space: nowrap; }
    .dtfh-floatingparent { z-index: 99999 !important; }

    @media (max-width: 768px) {
      body { padding: 8px; }
      table.dataTable { font-size: 12px; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <div class="meta">
      <div id="status">Loading projections…</div>
      <div id="updated"></div>
    </div>

    <table id="proj" class="display" style="width:100%">
      <thead><tr id="hdr"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_3ssLtkzQg1enNOwyvnvPKCaHvmC6RjpiOZ81YkP1LOHjKixRTyFbUqXr_UN9PoiaVYIpXmKDEr4B/pub?gid=0&single=true&output=csv";

    // Treat anything under this container width as “mobile”
    // (GoDaddy iframes can report weird widths; 950 is a safe breakpoint)
    const MOBILE_WIDTH_PX = 950;

    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];

        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === ',' && !inQuotes) { row.push(cur); cur = ""; continue; }

        if ((c === '\n' || c === '\r') && !inQuotes) {
          if (c === '\r' && n === '\n') i++;
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          row = []; cur = "";
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }

      return rows.filter(r => r.some(cell => String(cell ?? "").trim() !== ""));
    }

    function normalizeHeader(h) {
      return String(h ?? "").trim().toLowerCase();
    }

    function findColumnIndex(headers, candidates) {
      const normalized = headers.map(normalizeHeader);
      for (const cand of candidates) {
        const idx = normalized.indexOf(normalizeHeader(cand));
        if (idx !== -1) return idx;
      }
      return -1;
    }

    function isMobileNow() {
      const wrap = document.getElementById("wrap");
      const w = wrap ? wrap.getBoundingClientRect().width : window.innerWidth;
      return w < MOBILE_WIDTH_PX;
    }

    function applyMobileColumns(dt, headers) {
      const mobile = isMobileNow();

      // Find the 4 columns by name (case-insensitive)
      const idxPlayer = findColumnIndex(headers, ["Player", "Skater", "Name"]);
      const idxTeam   = findColumnIndex(headers, ["Team"]);
      const idxOpp    = findColumnIndex(headers, ["Opp", "Opponent"]);
      const idxProj   = findColumnIndex(headers, ["Projections", "Projection", "Proj"]);

      // If any header match fails, fallback to first 4 columns
      const fallback = [0, 1, 2, 3].filter(i => i < headers.length);
      const keep = [idxPlayer, idxTeam, idxOpp, idxProj].every(i => i >= 0)
        ? [idxPlayer, idxTeam, idxOpp, idxProj]
        : fallback;

      // Force visibility
      for (let i = 0; i < headers.length; i++) {
        dt.column(i).visible(!mobile); // desktop = show all
      }

      if (mobile) {
        for (let i = 0; i < headers.length; i++) dt.column(i).visible(false, false);
        keep.forEach(i => dt.column(i).visible(true, false));
      }

      // On mobile, no horizontal scroll needed
      // (scrollX is set at init, but we can still adjust layout)
      dt.columns.adjust().draw(false);

      // Debug line you can keep or remove
      document.getElementById("status").textContent = mobile
        ? "Loaded (Mobile view: 4 columns)"
        : "Loaded (Desktop view: all columns)";
    }

    async function init() {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV fetch failed: " + res.status);

      const csv = await res.text();
      const data = parseCSV(csv);
      if (!data.length || data.length < 2) throw new Error("CSV empty/missing rows.");

      const headers = data[0].map(h => String(h ?? "").trim());
      const body = data.slice(1);

      // Build header row
      const hdr = document.getElementById("hdr");
      hdr.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });

      const rows = body.map(r => headers.map((_, i) => String(r[i] ?? "").trim()));

      // Destroy if already exists
      if ($.fn.dataTable.isDataTable("#proj")) {
        $("#proj").DataTable().destroy();
        $("#proj tbody").empty();
      }

      const dt = $("#proj").DataTable({
        data: rows,
        columns: headers.map(h => ({ title: h })),

        // Sticky header in GoDaddy iframe
        scrollY: "65vh",
        scrollCollapse: true,

        // Keep this on for desktop (mobile will hide columns anyway)
        scrollX: true,

        paging: true,
        pageLength: 50,
        lengthMenu: [10, 25, 50, 100, 250],
        order: [],
        deferRender: true,

        fixedHeader: true
      });

      // Apply mobile/desktop column logic AFTER init (guaranteed)
      applyMobileColumns(dt, headers);

      document.getElementById("updated").textContent =
        "Updated: " + new Date().toLocaleString();

      // Re-apply on resize/orientation change (debounced)
      let t;
      window.addEventListener("resize", () => {
        clearTimeout(t);
        t = setTimeout(() => applyMobileColumns(dt, headers), 150);
      });
      window.addEventListener("orientationchange", () => {
        setTimeout(() => applyMobileColumns(dt, headers), 250);
      });
    }

    init().catch(err => {
      console.error(err);
      document.getElementById("status").textContent =
        "Error loading projections. Check CSV publish/link.";
    });
  </script>
</body>
</html>
