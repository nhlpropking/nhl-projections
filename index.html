<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL Projections</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    :root{
      --bg:#0b0f16;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --gold:#d4af37;
      --line:rgba(212,175,55,0.22);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --chip: rgba(212,175,55,0.08);
      --chipLine: rgba(212,175,55,0.28);
      --good: #22c55e;
    }

    *{ box-sizing:border-box; }
    html{ -webkit-text-size-adjust:100%; text-rendering: optimizeLegibility; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      margin:0;
      padding: 14px;
      background:
        radial-gradient(900px 500px at 30% 0%, rgba(212,175,55,0.08), transparent 55%),
        radial-gradient(900px 500px at 80% 30%, rgba(99,102,241,0.06), transparent 55%),
        var(--bg);
      color: var(--text);
      line-height:1.35;
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ====== command header ====== */
    .topbar{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,24,39,0.92), rgba(15,23,42,0.88));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
      margin-bottom: 12px;
      overflow:hidden;
      position:relative;
    }
    .topbar:after{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(70% 55% at 80% 30%, rgba(212,175,55,0.18), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }

    .title-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .titleblock{
      min-width: 240px;
    }
    .kicker{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--chipLine);
      background: var(--chip);
      color: var(--gold);
      font-weight: 800;
      font-size: 12.5px;
      letter-spacing: .2px;
    }
    h1{
      margin: 10px 0 2px;
      font-size: 22px;
      letter-spacing: -0.2px;
    }
    .sub{
      margin:0;
      color: rgba(229,231,235,0.72);
      font-size: 13px;
    }

    .meta{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(229,231,235,0.85);
      font-size: 12.5px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px; background: var(--good);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.12);
      flex-shrink:0;
    }

    /* ====== table shell ====== */
    .table-shell{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,24,39,0.88), rgba(15,23,42,0.86));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 10px 12px;
      overflow:hidden;
    }

    /* Keep FixedHeader on top inside iframe */
    .dtfh-floatingparent { z-index: 99999 !important; }

    /* ====== DataTables styling ====== */
    /* Controls row (search, length, info) */
    div.dataTables_wrapper div.dataTables_length label,
    div.dataTables_wrapper div.dataTables_filter label,
    div.dataTables_wrapper div.dataTables_info,
    div.dataTables_wrapper div.dataTables_paginate{
      color: rgba(229,231,235,0.78) !important;
      font-size: 12.5px;
    }

    /* Inputs */
    div.dataTables_wrapper div.dataTables_filter input,
    div.dataTables_wrapper div.dataTables_length select{
      background: rgba(255,255,255,0.04) !important;
      border: 1px solid rgba(229,231,235,0.14) !important;
      color: var(--text) !important;
      border-radius: 10px !important;
      padding: 7px 10px !important;
      outline: none !important;
    }
    div.dataTables_wrapper div.dataTables_filter input:focus,
    div.dataTables_wrapper div.dataTables_length select:focus{
      border-color: rgba(212,175,55,0.35) !important;
      box-shadow: 0 0 0 3px rgba(212,175,55,0.10) !important;
    }

    /* Table base */
    table.dataTable{
      border-collapse: separate !important;
      border-spacing: 0 !important;
      width:100% !important;
      color: var(--text) !important;
    }

    /* Header row */
    table.dataTable thead th{
      white-space: nowrap;
      background: rgba(255,255,255,0.03) !important;
      color: rgba(229,231,235,0.9) !important;
      border-bottom: 1px solid rgba(212,175,55,0.22) !important;
      padding: 10px 10px !important;
    }

    /* Body cells */
    table.dataTable tbody td{
      padding: 10px 10px !important;
      border-top: 1px solid rgba(255,255,255,0.06) !important;
      color: rgba(229,231,235,0.88) !important;
    }

    /* Row hover */
    table.dataTable tbody tr:hover{
      background: rgba(212,175,55,0.06) !important;
    }

    /* Pagination buttons */
    .dataTables_wrapper .dataTables_paginate .paginate_button{
      border-radius: 10px !important;
      border: 1px solid rgba(229,231,235,0.12) !important;
      background: rgba(255,255,255,0.03) !important;
      color: rgba(229,231,235,0.85) !important;
      margin: 0 2px !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover{
      border-color: rgba(212,175,55,0.35) !important;
      background: rgba(212,175,55,0.10) !important;
      color: var(--text) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current{
      border-color: rgba(212,175,55,0.45) !important;
      background: rgba(212,175,55,0.16) !important;
      color: var(--text) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled{
      opacity: .45 !important;
      cursor: default !important;
    }

    /* Remove default striping so our hover looks clean */
    table.dataTable.stripe tbody tr.odd,
    table.dataTable.display tbody tr.odd{
      background-color: transparent !important;
    }

    /* Make DataTables ‚Äúprocessing‚Äù readable if it shows */
    div.dataTables_processing{
      background: rgba(15,23,42,0.92) !important;
      border: 1px solid var(--line) !important;
      color: var(--text) !important;
      border-radius: 12px !important;
      box-shadow: var(--shadow) !important;
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      h1{ font-size: 20px; }
      table.dataTable { font-size: 12px; }
      table.dataTable thead th,
      table.dataTable tbody td{ padding: 9px 8px !important; }
      .topbar{ padding: 12px; }
      .table-shell{ padding: 8px; }
      .meta{ justify-content:flex-start; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">

    <!-- ‚úÖ NEW: premium command header (visual only) -->
    <div class="topbar">
      <div class="title-row">
        <div class="titleblock">
          <div class="kicker">üëë NHLPropKing ‚Ä¢ Projection Model</div>
          <h1>NHL Projections</h1>
          <p class="sub">Fast, searchable, mobile-friendly. Built for the King‚Äôs Men.</p>
        </div>
        <div class="meta">
          <div class="pill"><span class="dot"></span><span id="status">Loading projections‚Ä¶</span></div>
          <div class="pill" id="updated"></div>
        </div>
      </div>
    </div>

    <div class="table-shell">
      <table id="proj" class="display" style="width:100%">
        <thead><tr id="hdr"></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_3ssLtkzQg1enNOwyvnvPKCaHvmC6RjpiOZ81YkP1LOHjKixRTyFbUqXr_UN9PoiaVYIpXmKDEr4B/pub?gid=0&single=true&output=csv";

    // Treat anything under this container width as ‚Äúmobile‚Äù
    // (GoDaddy iframes can report weird widths; 950 is a safe breakpoint)
    const MOBILE_WIDTH_PX = 950;

    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];

        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === ',' && !inQuotes) { row.push(cur); cur = ""; continue; }

        if ((c === '\n' || c === '\r') && !inQuotes) {
          if (c === '\r' && n === '\n') i++;
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          row = []; cur = "";
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }

      return rows.filter(r => r.some(cell => String(cell ?? "").trim() !== ""));
    }

    function normalizeHeader(h) {
      return String(h ?? "").trim().toLowerCase();
    }

    function findColumnIndex(headers, candidates) {
      const normalized = headers.map(normalizeHeader);
      for (const cand of candidates) {
        const idx = normalized.indexOf(normalizeHeader(cand));
        if (idx !== -1) return idx;
      }
      return -1;
    }

    function isMobileNow() {
      const wrap = document.getElementById("wrap");
      const w = wrap ? wrap.getBoundingClientRect().width : window.innerWidth;
      return w < MOBILE_WIDTH_PX;
    }

    function applyMobileColumns(dt, headers) {
      const mobile = isMobileNow();

      // Find the 4 columns by name (case-insensitive)
      const idxPlayer = findColumnIndex(headers, ["Player", "Skater", "Name"]);
      const idxTeam   = findColumnIndex(headers, ["Team"]);
      const idxOpp    = findColumnIndex(headers, ["Opp", "Opponent"]);
      const idxProj   = findColumnIndex(headers, ["Projections", "Projection", "Proj"]);

      // If any header match fails, fallback to first 4 columns
      const fallback = [0, 1, 2, 3].filter(i => i < headers.length);
      const keep = [idxPlayer, idxTeam, idxOpp, idxProj].every(i => i >= 0)
        ? [idxPlayer, idxTeam, idxOpp, idxProj]
        : fallback;

      // Force visibility
      for (let i = 0; i < headers.length; i++) {
        dt.column(i).visible(!mobile); // desktop = show all
      }

      if (mobile) {
        for (let i = 0; i < headers.length; i++) dt.column(i).visible(false, false);
        keep.forEach(i => dt.column(i).visible(true, false));
      }

      dt.columns.adjust().draw(false);

      // Status text remains your existing behavior (just nicer container now)
      document.getElementById("status").textContent = mobile
        ? "Loaded (Mobile view: 4 columns)"
        : "Loaded (Desktop view: all columns)";
    }

    async function init() {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV fetch failed: " + res.status);

      const csv = await res.text();
      const data = parseCSV(csv);
      if (!data.length || data.length < 2) throw new Error("CSV empty/missing rows.");

      const headers = data[0].map(h => String(h ?? "").trim());
      const body = data.slice(1);

      // Build header row
      const hdr = document.getElementById("hdr");
      hdr.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });

      const rows = body.map(r => headers.map((_, i) => String(r[i] ?? "").trim()));

      // Destroy if already exists
      if ($.fn.dataTable.isDataTable("#proj")) {
        $("#proj").DataTable().destroy();
        $("#proj tbody").empty();
      }

      const dt = $("#proj").DataTable({
        data: rows,
        columns: headers.map(h => ({ title: h })),

        // Sticky header in GoDaddy iframe
        scrollY: "65vh",
        scrollCollapse: true,

        // Keep this on for desktop (mobile will hide columns anyway)
        scrollX: true,

        paging: true,
        pageLength: 50,
        lengthMenu: [10, 25, 50, 100, 250],
        order: [],
        deferRender: true,

        fixedHeader: true
      });

      applyMobileColumns(dt, headers);

      document.getElementById("updated").textContent =
        "Updated: " + new Date().toLocaleString();

      let t;
      window.addEventListener("resize", () => {
        clearTimeout(t);
        t = setTimeout(() => applyMobileColumns(dt, headers), 150);
      });
      window.addEventListener("orientationchange", () => {
        setTimeout(() => applyMobileColumns(dt, headers), 250);
      });
    }

    init().catch(err => {
      console.error(err);
      document.getElementById("status").textContent =
        "Error loading projections. Check CSV publish/link.";
      document.getElementById("updated").textContent = "";
    });
  </script>
</body>
</html>
