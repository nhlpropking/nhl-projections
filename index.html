<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL Projections</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 12px; }
    .wrap { max-width: 1400px; margin: 0 auto; }
    .meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    table.dataTable thead th { white-space: nowrap; }
    .dtfh-floatingparent { z-index: 99999 !important; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="meta">
      <div id="status">Loading projectionsâ€¦</div>
      <div id="updated"></div>
    </div>

    <table id="proj" class="display" style="width:100%">
      <thead>
        <tr id="hdr"></tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <script>

    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_3ssLtkzQg1enNOwyvnvPKCaHvmC6RjpiOZ81YkP1LOHjKixRTyFbUqXr_UN9PoiaVYIpXmKDEr4B/pub?gid=0&single=true&output=csv";

    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];

        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === ',' && !inQuotes) { row.push(cur); cur = ""; continue; }

        if ((c === '\n' || c === '\r') && !inQuotes) {
          if (c === '\r' && n === '\n') i++;
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          row = []; cur = "";
          continue;
        }
        cur += c;
      }

      if (cur.length || row.length) { row.push(cur); rows.push(row); }

      return rows.filter(r => r.some(cell => cell.trim() !== ""));
    }

    function isNumeric(val) {
      if (!val) return false;
      return !isNaN(val.replace(/[%,$]/g, ""));
    }

    async function loadTable() {

      const res = await fetch(CSV_URL, { cache: "no-store" });
      const csv = await res.text();

      const data = parseCSV(csv);

      const headers = data[0];
      const body = data.slice(1);

      const hdr = document.getElementById("hdr");
      hdr.innerHTML = "";

      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hdr.appendChild(th);
      });

      const rows = body.map(r => headers.map((_, i) => (r[i] || "").trim()));

      const colDefs = headers.map((_, i) => {
        const sample = rows.slice(0, 20).map(r => r[i]).filter(Boolean);
        const numericish = sample.length && sample.every(isNumeric);
        return numericish ? { targets: i, className: "dt-body-right" } : { targets: i };
      });

      $("#proj").DataTable({
        data: rows,
        columns: headers.map(h => ({ title: h })),

        scrollY: "65vh",
        scrollCollapse: true,
        scrollX: true,

        pageLength: 50,
        lengthMenu: [10, 25, 50, 100, 250],

        order: [],
        deferRender: true,

        fixedHeader: true,

        columnDefs: colDefs
      });

      document.getElementById("status").textContent = "Loaded";
      document.getElementById("updated").textContent =
        "Updated: " + new Date().toLocaleString();
    }

    loadTable();

  </script>

</body>
</html>
